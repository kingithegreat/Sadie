name: "Debug: E2E Streaming"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - 'feat/**'

jobs:
  sanity:
    name: Sanity (scheduling check)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Sanity echo
        run: |
          echo "SANITY: branch=$GITHUB_REF event=$GITHUB_EVENT_NAME sha=$GITHUB_SHA"
          node --version || true
          npx playwright --version || true

  debug:
    name: Debug E2E (single test)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Runner info
        run: |
          echo "RUNNER: $RUNNER_OS"
          echo "GITHUB_RUN_ID: $GITHUB_RUN_ID"
          echo "GITHUB_REF: $GITHUB_REF"
          uname -a || true
          lsb_release -a || true
          cat /etc/os-release || true
          node --version || true
          npm --version || true
          npx playwright --version || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright browsers and deps
        working-directory: widget
        run: npx playwright install --with-deps

      - name: Install widget deps
        run: npm ci --prefix widget

      - name: Build widget
        run: npm run build --prefix widget

      - name: Workspace diagnostics
        run: |
          echo "-- tree: widget/ --"
          ls -la widget || true
          echo "-- installed packages (widget) --"
          npm ls --prefix widget --depth=0 || true
          echo "-- disk / memory --"
          df -h || true
          free -m || true

      - name: Run single streaming E2E test (trace on)
        working-directory: widget
        run: |
          mkdir -p test-results || true
          echo "RUNNING: playwright test (single spec)"
          # Capture stdout+stderr to a log file for later inspection and avoid failing the job so we always upload artifacts.
          npx playwright test src/renderer/e2e/streaming.e2e.spec.ts -g "handles upstream error" --trace on --reporter=line 2>&1 | tee test-results/debug-playwright.log || true

      - name: Post-test diagnostics
        run: |
          echo "-- traces/ --"
          ls -la widget/traces || true
          echo "-- playwright-report/ --"
          ls -la widget/playwright-report || true
          echo "-- test-results/ --"
          ls -la widget/test-results || true
          echo "-- debug playwright log (tail) --"
          tail -n +1 widget/test-results/debug-playwright.log || true

      - name: Upload Playwright Artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-e2e-artifacts-${{ github.run_id }}
          path: |
            widget/playwright-report/
            widget/test-results/
            widget/traces/
            widget/test-results/videos/
