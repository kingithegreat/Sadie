name: Playwright E2E Tests

on:
  push:
    branches: [ main, followup/stash-wip ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Start docker services
        run: docker compose up -d

      - name: Install widget dependencies
        run: npm ci --prefix widget

      - name: Fix Electron sandbox permissions
        if: runner.os == 'Linux'
        run: |
          sudo chown root:root widget/node_modules/electron/dist/chrome-sandbox
          sudo chmod 4755 widget/node_modules/electron/dist/chrome-sandbox

      - name: Install Playwright browsers
        run: npm run e2e:install --prefix widget

      - name: Build widget
        env:
          NODE_ENV: test
        run: npm run build --prefix widget

      - name: Install Xvfb
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run Playwright E2E (Linux)
        if: runner.os == 'Linux'
        env:
          SADIE_E2E: '1'
          NODE_ENV: 'test'
        # pass Playwright CLI arg to retain traces on failure
        run: xvfb-run -s "-screen 0 1920x1080x24" npm run e2e --prefix widget -- --grep "SADIE can summarise a document" --trace=retain-on-failure

      - name: Run Playwright E2E (non-Linux)
        if: runner.os != 'Linux'
        env:
          SADIE_E2E: '1'
          NODE_ENV: 'test'
        run: npm run e2e --prefix widget -- --grep "SADIE can summarise a document" --trace=retain-on-failure

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: widget/playwright-report

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit
          path: widget/test-results

      - name: Upload traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: traces

      - name: Upload videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: widget/test-results/**/videos

      - name: Teardown docker services
        if: always()
        run: docker compose down --volumes
